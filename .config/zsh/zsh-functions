function zsh_add_file() {
    [ -f "$1" ] && source "$1"
}

function zsh_add_plugin() {
    local PLUGIN_NAME=$(echo $1 | cut -d "/" -f 2)
    local SYS_DIR="/usr/share/zsh/plugins/$PLUGIN_NAME"
    local LOC_DIR="$ZDOTDIR/plugins/$PLUGIN_NAME"

    # 1. Rendszerszintű (Arch/AUR) verzió keresése
    if [ -d "$SYS_DIR" ]; then
        fpath=($SYS_DIR $fpath)
        # Itt is az okos keresést használjuk a biztonság kedvéért
        local SYS_INIT=$(ls "$SYS_DIR"/*.plugin.zsh "$SYS_DIR"/*.zsh 2>/dev/null | grep -v "/_" | head -n 1)
        zsh_add_file "$SYS_INIT"
        return
    fi

    # 2. Letöltés, ha nincs meg helyileg
    if [ ! -d "$LOC_DIR" ]; then
        echo "Plugin letöltése: $PLUGIN_NAME..."
        mkdir -p "$ZDOTDIR/plugins"
        git clone --depth 1 "https://github.com/$1.git" "$LOC_DIR"
    fi

    # 3. Helyi betöltés és fpath frissítés
    fpath=($LOC_DIR $fpath)
    
    # Megkeressük az indítófájlt:
    # - Először a .plugin.zsh-t keressük, utána a sima .zsh-t
    # - Kizárjuk a kiegészítőket (amik _ jellel kezdődnek)
    local INIT_FILE=$(ls "$LOC_DIR"/*.plugin.zsh "$LOC_DIR"/*.zsh 2>/dev/null | grep -v "/_" | head -n 1)

    if [ -n "$INIT_FILE" ]; then
        source "$INIT_FILE"
    else
        # Végső mentőöv: ha nincs .zsh, de van .sh (ritka, de előfordul)
        zsh_add_file "$LOC_DIR/$PLUGIN_NAME.sh"
    fi
}
