#!/bin/bash

set -e

# Konfigurációs változók
SEARXNG_USER="searxng"
SEARXNG_HOME="/usr/local/searxng"
SEARXNG_SRC_DIR="$SEARXNG_HOME/searxng-src"
VENV_PATH="$SEARXNG_HOME/searx-pyenv"
CONFIG_DIR="/etc/searxng"
SERVICE_FILE="/etc/systemd/system/searxng.service"

echo "Szükséges csomagok telepítése..."
sudo pacman -Sy --noconfirm \
    python python-pip python-lxml python-babel \
    uwsgi uwsgi-plugin-python git base-devel libxml2 openssl

# Felhasználó létrehozása, ha nem létezik
if ! id -u $SEARXNG_USER >/dev/null 2>&1; then
    echo "Felhasználó létrehozása: $SEARXNG_USER"
    sudo useradd --system --shell /bin/bash --home-dir $SEARXNG_HOME $SEARXNG_USER
    sudo mkdir -p $SEARXNG_HOME
    sudo chown -R $SEARXNG_USER:$SEARXNG_USER $SEARXNG_HOME
fi

# Forrás klónozása vagy frissítése
if [ ! -d "$SEARXNG_SRC_DIR" ]; then
    echo "SearXNG forrás klónozása..."
    sudo -u $SEARXNG_USER git clone https://github.com/searxng/searxng $SEARXNG_SRC_DIR
else
    echo "SearXNG forrás könyvtár létezik, frissítés git pull-al..."
    sudo -u $SEARXNG_USER bash -c "cd $SEARXNG_SRC_DIR && git pull"
fi

# Virtuális környezet létrehozása, pip frissítés és csomagok telepítése
if [ ! -d "$VENV_PATH" ]; then
    echo "Virtuális környezet létrehozása..."
    sudo -u $SEARXNG_USER python3 -m venv $VENV_PATH
fi

echo "Függőségek telepítése a virtuális környezetben..."
sudo -u $SEARXNG_USER bash -c "
source $VENV_PATH/bin/activate
pip install --upgrade pip setuptools wheel pyyaml
cd $SEARXNG_SRC_DIR
pip install --use-pep517 --no-build-isolation -e .
deactivate
"

# Konfigurációs könyvtár és fájl előkészítése
sudo mkdir -p $CONFIG_DIR
sudo cp $SEARXNG_SRC_DIR/utils/templates/etc/searxng/settings.yml $CONFIG_DIR/settings.yml
sudo sed -i "s/ultrasecretkey/$(openssl rand -hex 16)/g" $CONFIG_DIR/settings.yml
sudo chown -R $SEARXNG_USER:$SEARXNG_USER $CONFIG_DIR

# Systemd szolgáltatás létrehozása
echo "Systemd szolgáltatás létrehozása..."
sudo tee $SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=SearXNG Search Engine
After=network.target

[Service]
User=$SEARXNG_USER
Group=$SEARXNG_USER
WorkingDirectory=$SEARXNG_SRC_DIR
Environment=SEARXNG_SETTINGS_PATH=$CONFIG_DIR/settings.yml
ExecStart=$VENV_PATH/bin/python $SEARXNG_SRC_DIR/searx/webapp.py
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# Systemd daemon újratöltés és szolgáltatás engedélyezése, indítása
sudo systemctl daemon-reload
sudo systemctl enable searxng.service
sudo systemctl start searxng.service

echo "Telepítés és rendszerindítás kész."
echo "A SearXNG elérhető lesz a http://127.0.0.1:8888 címen."
